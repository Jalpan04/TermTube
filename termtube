#!/bin/bash

# TermTube - A TUI wrapper for yt-dlp
# Author: TermTube Dev
# Version: 1.0

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for dependencies
# Check for dependencies
DEPENDENCIES=("yt-dlp" "jq" "fzf" "ffmpeg" "node")
MISSING_DEPS=()

for dep in "${DEPENDENCIES[@]}"; do
    if ! command -v "$dep" &> /dev/null; then
        MISSING_DEPS+=("$dep")
    fi
done

if [ ${#MISSING_DEPS[@]} -ne 0 ]; then
    echo -e "${RED}Error: Missing dependencies: ${MISSING_DEPS[*]}${NC}"
    echo "Please install them using your package manager or run install.sh"
    exit 1
fi

# Function to search and download
search_and_download() {
    echo -e "${BLUE}TermTube - YouTube Downloader & Player${NC}"
    echo -n "Enter search query: "
    read -r QUERY

    if [ -z "$QUERY" ]; then
        echo -e "${RED}Search query cannot be empty.${NC}"
        exit 1
    fi

    echo -e "${YELLOW}Searching for '$QUERY'...${NC}"

    # Search and parse results into a format for fzf
    # Format: Title | Channel | Duration | ID
    RESULTS=$(yt-dlp "ytsearch15:$QUERY" \
        --extractor-args "youtube:player_client=android,web" \
        --dump-json --flat-playlist 2>/dev/null | \
        jq -r '[.title, .channel, .duration_string, .id] | @tsv')

    if [ -z "$RESULTS" ]; then
        echo -e "${RED}No results found.${NC}"
        exit 1
    fi

    # Select video using fzf
    SELECTED=$(echo "$RESULTS" | fzf --delimiter=$'\t' --with-nth=1,2,3 \
        --header="Select a video (Enter to confirm)" \
        --color=fg:white,bg:black,hl:blue,fg+:blue,bg+:black,hl+:cyan \
        --layout=reverse --height=40% --border)

    if [ -z "$SELECTED" ]; then
        echo "No video selected. Exiting."
        exit 0
    fi

    # Extract Video ID (last field)
    VIDEO_ID=$(echo "$SELECTED" | awk -F'\t' '{print $4}')
    VIDEO_TITLE=$(echo "$SELECTED" | awk -F'\t' '{print $1}')

    echo -e "${GREEN}Selected: $VIDEO_TITLE${NC}"

    # Download Logic with Simplified Menu
    echo -e "${YELLOW}Fetching formats...${NC}"

    # Simplified Format Options
    FORMAT_OPTIONS="Best Quality (Video+Audio)\n1080p (MP4)\n720p (MP4)\n480p (MP4)\nAudio Only (MP3)\nManual Selection (Advanced)"
    
    CHOSEN_FORMAT_LABEL=$(echo -e "$FORMAT_OPTIONS" | fzf --header="Select Quality/Format" --layout=reverse --height=30% --border)

    FORMAT_OPT=""
    OUTPUT_TEMPLATE="%(title)s.%(ext)s"

    case "$CHOSEN_FORMAT_LABEL" in
        "Best Quality (Video+Audio)")
            FORMAT_OPT="-f bestvideo+bestaudio/best --merge-output-format mp4"
            ;;
        "1080p (MP4)")
            FORMAT_OPT="-f bestvideo[height<=1080]+bestaudio/best[height<=1080] --merge-output-format mp4"
            ;;
        "720p (MP4)")
            FORMAT_OPT="-f bestvideo[height<=720]+bestaudio/best[height<=720] --merge-output-format mp4"
            ;;
        "480p (MP4)")
            FORMAT_OPT="-f bestvideo[height<=480]+bestaudio/best[height<=480] --merge-output-format mp4"
            ;;
        "Audio Only (MP3)")
            FORMAT_OPT="-f bestaudio --extract-audio --audio-format mp3"
            ;;
        "Manual Selection (Advanced)")
            FORMAT_SELECTION=$(yt-dlp -F "$VIDEO_ID" 2>/dev/null | grep -E "^[0-9]+|ID" | \
                fzf --header="Select Manual Format Code" --layout=reverse --height=60% --border)
            if [ -n "$FORMAT_SELECTION" ]; then
                FORMAT_CODE=$(echo "$FORMAT_SELECTION" | awk '{print $1}')
                FORMAT_OPT="-f $FORMAT_CODE"
            else
                echo "No manual format selected. Exiting."
                exit 0
            fi
            ;;
        *)
            echo "No format selected. Exiting."
            exit 0
            ;;
    esac

    # Ask for download location
    echo -n "Download to current directory? [Y/n]: "
    read -r LOC_CONFIRM
    LOC_CONFIRM=${LOC_CONFIRM:-Y}

    if [[ "$LOC_CONFIRM" =~ ^[Nn]$ ]]; then
        echo -n "Enter target directory: "
        read -r TARGET_DIR
        mkdir -p "$TARGET_DIR"
        cd "$TARGET_DIR" || exit
    fi

    echo -e "${BLUE}Downloading...${NC}"
    
    # Download
    # shellcheck disable=SC2086
    yt-dlp $FORMAT_OPT \
        --extractor-args "youtube:player_client=android,web" \
        --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" \
        -o "$OUTPUT_TEMPLATE" "$VIDEO_ID"

    echo -e "${GREEN}Download Complete!${NC}"
}

# Run the main function
search_and_download
